<div class="min-h-screen bg-gray-50 py-8 px-4">
  <div class="max-w-4xl mx-auto">
    <app-loading-bar [reloading]="reloading()"></app-loading-bar>

    @if (error()) {
      <mat-card class="bg-red-50 border-l-4 border-red-500 mb-6">
        <mat-card-content class="flex items-center gap-3">
          <mat-icon class="text-red-500">error</mat-icon>
          <div>
            <h3 class="font-semibold text-red-900">{{ 'RESERVATION.Details.LoadingError' | translate }}</h3>
            <p class="text-red-700">{{ error()?.message || 'Failed to load reservation' }}</p>
          </div>
        </mat-card-content>
      </mat-card>
    }

    @if (data()) {
      <mat-card class="shadow-lg">
        <!-- Header -->
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
          <h2 class="text-2xl font-semibold text-gray-800">{{ 'RESERVATION.Details.Title' | translate }}</h2>
        </div>

        <!-- Status Bar -->
        <div class="p-4 border-b border-gray-200 flex flex-wrap gap-4 justify-center md:justify-between">
          <lib-visitor-type [data]="visitor()?.type!!"/>
          <lib-verification-status [data]="verification()!!"/>
          <lib-booking-status [status]="status()"/>
        </div>

        @if (!isEditable()) {
          <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <div class="flex items-center gap-2">
              <mat-icon class="text-yellow-600">info</mat-icon>
              <p class="text-yellow-800">{{ 'RESERVATION.Details.NotEditable' | translate }}</p>
            </div>
          </div>
        }

        <!-- Time Slot Section -->
        <div class="flex flex-col gap-4 p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold flex items-center gap-2">
            <mat-icon class="text-primary">event</mat-icon>
            {{ 'RESERVATION.Details.Offer' | translate }}
          </h3>
          <mat-card appearance="outlined" class="!p-4 bg-gradient-to-br from-white to-gray-50">
            <div class="flex items-start gap-4">
              <div class="bg-primary/10 rounded-lg p-3 hidden sm:block">
                <mat-icon class="text-primary text-3xl">calendar_today</mat-icon>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1">
                    <div class="font-semibold text-lg text-gray-900">{{ start() | date:'fullDate' }}</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center gap-1">
                      <mat-icon class="text-base">schedule</mat-icon>
                      {{ start() | date:'shortTime' }} - {{ finish() | date:'shortTime' }}
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2 text-sm mt-3 text-gray-600">
                  <mat-icon class="text-base">people</mat-icon>
                  <span>{{ 'SUMMARY.TimeSlots.MaxPersons' | translate: {count: maxPersons()} }}</span>
                </div>
              </div>
            </div>
          </mat-card>
        </div>

        <!-- Visitor Information Section -->
        <div class="p-6 border-b border-gray-200">
          <!-- Use your existing visitor info component for non-editable fields -->
          <app-visitor-info [data]="visitor()!!"></app-visitor-info>
        </div>

        <!-- Comment Section - Editable -->
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold flex items-center gap-2">
              <mat-icon class="text-primary">comment</mat-icon>
              {{ 'REQUEST.Form.Comment.Label' | translate }}
            </h3>
            @if (isEditable() && !commentField().isEditing && commentField().currentValue) {
              <button
                matIconButton
                (click)="startEdit('comment')"
                [matTooltip]="'ACTION.Edit' | translate">
                <mat-icon class="!text-gray-700">edit</mat-icon>
              </button>
            }
          </div>

          @if (commentField().isEditing) {
            <div class="space-y-3">
              <mat-form-field class="w-full" appearance="outline">
                    <textarea
                      matInput
                      [(ngModel)]="editingValue"
                      rows="4"
                      [placeholder]="'REQUEST.Form.Comment.Placeholder' | translate"
                      (keydown.escape)="cancelEdit('comment')"></textarea>
              </mat-form-field>
              <div class="flex gap-2 justify-end">
                <button mat-stroked-button (click)="cancelEdit('comment')">
                  <mat-icon>close</mat-icon>
                  {{ 'ACTION.Cancel' | translate }}
                </button>
                <button mat-flat-button color="primary" (click)="saveEdit('comment')">
                  <mat-icon>check</mat-icon>
                  {{ 'ACTION.Save' | translate }}
                </button>
              </div>
            </div>
          } @else {
            @if (commentField().currentValue) {
              <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-gray-800 whitespace-pre-wrap">{{ commentField().currentValue }}</p>
              </div>
            } @else if (isEditable()) {
              <div class="bg-gray-50 rounded-lg p-4 border border-dashed border-gray-300 text-center">
                <p class="text-gray-500 mb-3">{{ 'REQUEST.Form.Comment.Empty' | translate }}</p>
                <button mat-stroked-button (click)="startEdit('comment')" [disabled]="reloading()">
                  <mat-icon>add_comment</mat-icon>
                  {{ 'BOOKING.Action.Comment' | translate }}
                </button>
              </div>
            }
          }
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 p-6 bg-gray-50">
          @if (!commentField().isEditing && isEditable()) {
            @if (!commentField().currentValue) {
              <button mat-stroked-button (click)="startEdit('comment')">
                <mat-icon>add_comment</mat-icon>
                {{ 'BOOKING.Action.Comment' | translate }}
              </button>
            }
            <button mat-stroked-button (click)="updateSize()" [disabled]="reloading()">
              <mat-icon>group</mat-icon>
              {{ 'BOOKING.Action.Resize' | translate }}
            </button>
            <button mat-stroked-button class="!text-red-600 !border-red-300 hover:!bg-red-50" (click)="cancel()"
                    [disabled]="reloading()">
              <mat-icon>cancel</mat-icon>
              {{ 'BOOKING.Action.Cancel' | translate }}
            </button>
          }
        </div>

        <!-- Footer -->
        <div class="px-6 py-3 flex justify-center items-center gap-2 bg-gray-100 border-t border-gray-200">
          <mat-icon class="text-gray-500 text-base">update</mat-icon>
          <p class="text-sm text-gray-600">{{ 'COMMON.LastUpdated' | translate }}</p>
          <p class="text-sm font-medium text-gray-800">{{ timestamp() | date:'medium' }}</p>
        </div>
      </mat-card>
    }
  </div>
</div>

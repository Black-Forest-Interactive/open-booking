<div class="flex flex-col gap-2 flex-1">

  @if (processing()) {
    <div class="px-6 py-3 bg-blue-50 border-b border-blue-200">
      <div class="flex items-center gap-3">
        <mat-spinner diameter="20"></mat-spinner>
        <span class="text-sm text-blue-900 font-medium">{{ 'COMMON.Updating' | translate }}</span>
      </div>
    </div>
  }

  @if (result(); as data) {
    <div class="flex flex-col items-center justify-center min-h-[200px] p-4">
      <!-- Header -->
      <div class="pb-4">
        <div class="flex items-center gap-3 w-full">
          @if (data.success) {
            <mat-icon class="text-green-600 text-3xl">check_circle</mat-icon>
          } @else {
            <mat-icon class="text-red-600 text-3xl">error</mat-icon>
          }
          <div class="text-xl font-semibold m-0">
            @if (data.success) {
              <span class="text-green-700">{{ 'COMMON.Title.Success' | translate }}</span>
            } @else {
              <span class="text-red-700">{{ 'COMMON.Title.Error' | translate }}</span>
            }
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="mt-2">
        <p class="text-gray-700 leading-relaxed">
          {{ data.msg | translate }}
        </p>
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <button matButton="filled" (click)="completed.emit(true)">
          <mat-icon>save</mat-icon>
          {{ 'ACTION.Ok' | translate }}
        </button>
      </div>
    </div>
  } @else if (booking()) {
    <div class="flex flex-col gap-3">
      @if (bookingInfo()) {
        <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded mb-3">
          <div class="flex flex-col gap-3">
            <div class="flex gap-3">
              <div class="w-48 font-medium">{{ 'BOOKING.Form.Name.Label' | translate }}</div>
              <div>{{ bookingInfo()!!.visitor.name }}</div>
            </div>
            <div class="flex gap-3">
              <div class="w-48 font-medium">{{ 'BOOKING.Form.Size.Label' | translate }}</div>
              <div>{{ bookingInfo()!!.visitor.size }}</div>
            </div>
          </div>
        </div>
        @if (bookingInfo()?.comment?.length) {
          <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded mb-3">
            <div class="flex gap-3">
              <div class="w-48 font-medium">{{ 'BOOKING.Form.Comment.Label' | translate }}</div>
              <div>{{ bookingInfo()!!.comment }}</div>
            </div>
          </div>
        }
      }
      @if (response()) {
        <form [formGroup]="responseForm">
          <div class="flex flex-col">
            <mat-form-field appearance="fill">
              <mat-label>{{ 'RESERVATION.Dialog.Confirm.Form.Subject' | translate }}</mat-label>
              <input matInput type="text" formControlName="subject">
            </mat-form-field>
            <quill-editor formControlName="content" placeholder="Enter Text" class="pb-3"></quill-editor>
            <mat-slide-toggle formControlName="silent">
              {{ 'RESERVATION.Dialog.Confirm.Form.Silent' | translate }}
            </mat-slide-toggle>
          </div>
        </form>
      }

      <div class="flex justify-end gap-2 flex-1">
        <button matButton="outlined" (click)="cancel.emit(true)">
          <mat-icon>cancel</mat-icon>
          {{ 'ACTION.Cancel' | translate }}
        </button>
        <button matButton="filled" [disabled]="!requestForm.valid || processing()" (click)="onSubmitResponse()">
          <mat-icon>save</mat-icon>
          {{ 'ACTION.Submit' | translate }}
        </button>
      </div>
    </div>
  } @else {
    <div class="flex flex-col gap-3">

      <app-offer-booking-capacity
        [assignment]="assignment()"
        [offer]="offer()"
        [status]="BookingStatus.PENDING"
        [visitorSize]="size?.value ?? 0"
        [sizeUpdate]="true"
        [hideImpactInfo]="true"
      />

      <form [formGroup]="requestForm" class="flex flex-col gap-4">
        @if (assignment().availableSpace > 1) {
          <div class="flex items-center gap-4">
            <mat-button-toggle-group formControlName="type" class="w-full">
              <mat-button-toggle value="{{VisitorType.SINGLE}}" class="flex-1">
                {{ 'BOOKING.Form.BookingType.Single' | translate }}
              </mat-button-toggle>
              <mat-button-toggle value="{{VisitorType.GROUP}}" class="flex-1">
                {{ 'BOOKING.Form.BookingType.Group' | translate }}
              </mat-button-toggle>
              @if (requestForm.get('type')?.hasError('required')) {
                <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
              }
            </mat-button-toggle-group>
          </div>
        }

        <!-- GROUP MODE: Show title, size, minAge, maxAge, contact -->
        @if (type?.value === VisitorType.GROUP) {
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Title.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="title">
            @if (requestForm.get('title')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Title.Required' | translate }}</mat-error>
            }
          </mat-form-field>
        }
        <!-- SINGLE PERSON MODE: Show name and age only -->
        @if (type?.value === VisitorType.SINGLE) {
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Name.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="name">
          </mat-form-field>
        }

        <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
          <mat-label>{{ 'BOOKING.Form.Size.Label' | translate }}</mat-label>
          <input matInput type="number" formControlName="size">
          @if (requestForm.get('size')?.hasError('required')) {
            <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
          } @else if (requestForm.get('size')?.hasError('min')) {
            <mat-error>{{ 'BOOKING.Form.Size.MinSize' | translate }}</mat-error>
          }

        </mat-form-field>

        @if (size?.value > 1) {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
              <mat-label>{{ 'BOOKING.Form.MinAge.Label' | translate }}</mat-label>
              <input matInput type="number" formControlName="minAge">
              @if (requestForm.get('minAge')?.hasError('required')) {
                <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
              } @else if (requestForm.get('minAge')?.hasError('min')) {
                <mat-error>{{ 'BOOKING.Form.MinAge.MinValue' | translate: {min: 0} }}</mat-error>
              } @else if (requestForm.hasError('agesMustMatchForSingleVisitor')) {
                <mat-error>{{ 'BOOKING.Form.MinAge.AgesMustMatch' | translate }}</mat-error>
              }
            </mat-form-field>
            <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
              <mat-label>{{ 'BOOKING.Form.MaxAge.Label' | translate }}</mat-label>
              <input matInput type="number" formControlName="maxAge">
              @if (requestForm.get('maxAge')?.hasError('required')) {
                <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
              } @else if (requestForm.get('maxAge')?.hasError('min')) {
                <mat-error>{{ 'BOOKING.Form.MaxAge.MinValue' | translate: {min: 0} }}</mat-error>
              } @else if (requestForm.hasError('agesMustMatchForSingleVisitor')) {
                <mat-error>{{ 'BOOKING.Form.MaxAge.AgesMustMatch' | translate }}</mat-error>
              }
            </mat-form-field>
          </div>
        } @else {
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Age.Label' | translate }}</mat-label>
            <input matInput type="number" formControlName="minAge">
          </mat-form-field>
        }


        @if (type?.value === VisitorType.GROUP) {
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Contact.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="name">
            @if (requestForm.get('name')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
            }
          </mat-form-field>
        }

        <div class="grid grid-cols-3 gap-4">
          <mat-form-field class="col-span-1 dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Zip.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="zip">
            @if (requestForm.get('zip')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
            }
          </mat-form-field>
          <mat-form-field class="col-span-2 dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.City.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="city">
            @if (requestForm.get('city')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Phone.Label' | translate }}</mat-label>
            <input matInput type="text" formControlName="phone">
            @if (requestForm.get('phone')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
            }
          </mat-form-field>
          <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
            <mat-label>{{ 'BOOKING.Form.Mail.Label' | translate }}</mat-label>
            <input matInput type="email" formControlName="mail" email>
            @if (requestForm.get('mail')?.hasError('required')) {
              <mat-error>{{ 'BOOKING.Form.Required' | translate }}</mat-error>
            } @else if (requestForm.get('mail')?.hasError('email')) {
              <mat-error>{{ 'BOOKING.Form.Mail.Invalid' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field class="w-full dense-3" appearance="outline" subscriptSizing="dynamic">
          <mat-label>{{ 'BOOKING.Form.Comment.Label' | translate }}</mat-label>
          <textarea matInput formControlName="comment"></textarea>
        </mat-form-field>

        <!-- Boolean Flags -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-slide-toggle formControlName="autoConfirm">{{ 'BOOKING.Form.AutoConfirm.Label' | translate }}
          </mat-slide-toggle>
          <mat-slide-toggle formControlName="ignoreSizeCheck">{{ 'BOOKING.Form.IgnoreSizeCheck.Label' | translate }}
          </mat-slide-toggle>
        </div>

      </form>

      <div class="flex justify-end gap-2 flex-1">
        <button matButton="outlined" (click)="cancel.emit(true)">
          <mat-icon>cancel</mat-icon>
          {{ 'ACTION.Cancel' | translate }}
        </button>
        <button matButton="filled" [disabled]="!requestForm.valid || processing()" (click)="onSubmitRequest()">
          <mat-icon>save</mat-icon>
          {{ 'ACTION.Save' | translate }}
        </button>
      </div>

    </div>
  }

</div>
